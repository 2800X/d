<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arousal Control Training Tracker</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .app-container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .timer-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .time-display {
            font-size: 3rem;
            font-weight: bold;
            margin: 15px 0;
            color: #3498db;
        }
        
        .phase-container {
            margin-bottom: 20px;
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-success {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .stat-box {
            background-color: #f9f9f9;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 5px 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            text-transform: uppercase;
        }
        
        .log-container {
            margin-top: 30px;
        }
        
        #sessionLog {
            width: 100%;
            border-collapse: collapse;
        }
        
        #sessionLog th, #sessionLog td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        #sessionLog th {
            background-color: #f2f2f2;
        }
        
        #sessionLog tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .status-indicator {
            text-align: center;
            padding: 10px;
            border-radius: 5px;
            margin: 15px 0;
            font-weight: bold;
        }
        
        .rest-mode {
            background-color: #ffeaa7;
            color: #d35400;
        }
        
        .active-mode {
            background-color: #d5f5e3;
            color: #27ae60;
        }
        
        .phases {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 20px;
        }
        
        .phase-btn {
            background-color: #ecf0f1;
            color: #7f8c8d;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
        }
        
        .phase-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .completed-days-bar {
            width: 100%;
            height: 20px;
            background-color: #ecf0f1;
            border-radius: 10px;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .completed-days-fill {
            height: 100%;
            background-color: #3498db;
            border-radius: 10px;
            transition: width 0.5s;
        }
        
        .note-textarea {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            resize: vertical;
            min-height: 60px;
        }
        
        @media (max-width: 600px) {
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @keyframes flash {
            0% { background-color: #d5f5e3; }
            50% { background-color: #27ae60; }
            100% { background-color: #d5f5e3; }
        }
        
        .settings-box {
            background-color: #f9f9f9;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .settings-title {
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .settings-option {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .settings-option label {
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <h1>Arousal Control Training Tracker</h1>
        
        <div class="settings-box">
            <div class="settings-title">Sound & Alert Settings</div>
            <div class="settings-option">
                <input type="checkbox" id="soundEnabled" checked>
                <label for="soundEnabled">Enable sound alerts</label>
            </div>
            <div class="settings-option">
                <label for="soundVolume">Alert volume: </label>
                <input type="range" id="soundVolume" min="0" max="1" step="0.1" value="1" style="width: 100px;">
                <button id="testSoundBtn" class="btn-primary" style="padding: 5px 10px; margin-left: 10px;">Test Sound</button>
            </div>
            <div class="settings-option">
                <label for="restPeriodLength">Rest period length (seconds): </label>
                <input type="number" id="restPeriodLength" min="10" max="120" value="30" style="width: 60px;">
            </div>
        </div>
        
        <div class="phase-container">
            <h3>Select Current Phase:</h3>
            <div class="phases">
                <button class="phase-btn" data-phase="1">Phase 1</button>
                <button class="phase-btn" data-phase="2">Phase 2</button>
                <button class="phase-btn" data-phase="3">Phase 3</button>
                <button class="phase-btn" data-phase="4">Phase 4</button>
                <button class="phase-btn" data-phase="5">Phase 5</button>
                <button class="phase-btn" data-phase="6">Phase 6</button>
                <button class="phase-btn" data-phase="7">Phase 7</button>
                <button class="phase-btn" data-phase="8">Phase 8+</button>
            </div>
            
            <div id="daySelector" style="display: none; margin-top: 15px;">
                <h4>Select Training Day:</h4>
                <div class="phases">
                    <button class="phase-btn day-btn" data-day="1">Day 1</button>
                    <button class="phase-btn day-btn" data-day="2">Day 2</button>
                    <button class="phase-btn day-btn" data-day="3">Day 3</button>
                    <button class="phase-btn day-btn" data-day="4">Day 4</button>
                    <button class="phase-btn day-btn" data-day="5">Day 5</button>
                </div>
            </div>
            
            <div id="phaseDescription" style="margin-top: 10px; font-style: italic;">Select a phase to see description</div>
        </div>
        
        <div class="timer-container">
            <div class="time-display" id="timerDisplay">20:00</div>
            <div id="statusIndicator" class="status-indicator active-mode">Ready to Start</div>
        </div>
        
        <div class="stats-container">
            <div class="stat-box">
                <div class="stat-label">First PONR</div>
                <div class="stat-value" id="firstPONR">--:--</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Stops</div>
                <div class="stat-value" id="stopsCount">0</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Erection Level</div>
                <div class="stat-value" id="erectionLevel">-</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Urge (1-5)</div>
                <div class="stat-value" id="urgeLevel">-</div>
            </div>
        </div>
        
        <div class="controls">
            <button id="startBtn" class="btn-primary">Start Session</button>
            <button id="ponrBtn" class="btn-warning" disabled>Record First PONR</button>
            <button id="stopBtn" class="btn-danger" disabled>Record Stop (+30s Rest)</button>
            <button id="orgasmBtn" class="btn-danger" disabled>Record Orgasm</button>
            <button id="endBtn" class="btn-danger" disabled>End Session</button>
        </div>
        
        <div class="controls">
            <label for="erectionSelect">Erection (EHS):</label>
            <select id="erectionSelect" disabled>
                <option value="-">-</option>
                <option value="1">1 - Larger but not hard</option>
                <option value="2">2 - Hard but not enough for penetration</option>
                <option value="3">3 - Hard enough for penetration but not fully hard</option>
                <option value="4">4 - Completely hard and fully rigid</option>
                <option value="4.5">4.5 - Rock hard</option>
                <option value="5">5 - Maximum hardness</option>
            </select>
            
            <label for="urgeSelect" style="margin-left: 10px;">Urge Level:</label>
            <select id="urgeSelect" disabled>
                <option value="-">-</option>
                <option value="1">1 - Very low</option>
                <option value="1.5">1.5</option>
                <option value="2">2 - Low</option>
                <option value="2.5">2.5</option>
                <option value="3">3 - Moderate</option>
                <option value="3.5">3.5</option>
                <option value="4">4 - High</option>
                <option value="4.5">4.5</option>
                <option value="5">5 - Very high</option>
            </select>
        </div>
        
        <div class="session-notes">
            <h3>Session Notes</h3>
            <textarea id="sessionNotes" class="note-textarea" placeholder="Enter any notes about your session here..." disabled></textarea>
        </div>
    </div>
    
    <div class="app-container">
        <h2>Training Progress</h2>
        <h3>Current Phase: <span id="currentPhaseDisplay">Not Started</span></h3>
        
        <div>
            <h4>Completed Days in Current Phase: <span id="completedDaysCount">0</span>/5</h4>
            <div class="completed-days-bar">
                <div class="completed-days-fill" id="completedDaysFill" style="width: 0%"></div>
            </div>
        </div>
        
        <div class="log-container">
            <h3>Session Log</h3>
            <table id="sessionLog">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Phase</th>
                        <th>Day</th>
                        <th>Duration</th>
                        <th>First PONR</th>
                        <th>Stops</th>
                        <th>Erection</th>
                        <th>Orgasm</th>
                        <th>Urge (1-5)</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Session logs will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>
    
    <script>
        // Safe localStorage wrapper with fallback
        let tempStorage = {};
        
        function safeSetItem(key, value) {
            try {
                localStorage.setItem(key, value);
            } catch (e) {
                tempStorage[key] = value;
            }
        }
        
        function safeGetItem(key) {
            try {
                return localStorage.getItem(key);
            } catch (e) {
                return tempStorage[key] || null;
            }
        }
        
        // Timer variables with timestamp-based tracking
        let timerInterval;
        let sessionDuration = 20 * 60 * 1000; // 20 minutes in milliseconds
        let sessionStartTime = null;
        let sessionPauseTime = null;
        let totalPausedTime = 0;
        let isRunning = false;
        let isResting = false;
        let restEndTime = 0;
        let firstPONRTime = null;
        let stopsCount = 0;
        let currentPhase = null;
        let currentDay = null;
        let hasRecordedOrgasm = false;
        
        // Create audio elements for alerts
        const restEndAudio = new Audio('data:audio/wav;base64,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');
        
        // DOM elements
        const timerDisplay = document.getElementById('timerDisplay');
        const startBtn = document.getElementById('startBtn');
        const ponrBtn = document.getElementById('ponrBtn');
        const stopBtn = document.getElementById('stopBtn');
        const orgasmBtn = document.getElementById('orgasmBtn');
        const endBtn = document.getElementById('endBtn');
        const firstPONRDisplay = document.getElementById('firstPONR');
        const stopsCountDisplay = document.getElementById('stopsCount');
        const statusIndicator = document.getElementById('statusIndicator');
        const erectionSelect = document.getElementById('erectionSelect');
        const urgeSelect = document.getElementById('urgeSelect');
        const erectionLevelDisplay = document.getElementById('erectionLevel');
        const urgeLevelDisplay = document.getElementById('urgeLevel');
        const sessionNotes = document.getElementById('sessionNotes');
        const phaseButtons = document.querySelectorAll('.phase-btn:not(.day-btn)');
        const dayButtons = document.querySelectorAll('.day-btn');
        const daySelector = document.getElementById('daySelector');
        const currentPhaseDisplay = document.getElementById('currentPhaseDisplay');
        const completedDaysCount = document.getElementById('completedDaysCount');
        const completedDaysFill = document.getElementById('completedDaysFill');
        const phaseDescription = document.getElementById('phaseDescription');
        
        // Phase descriptions
        const phaseDescriptions = {
            1: "Peak and Valley training - Stimulate to just before 9/10, stop completely, wait 30-60 seconds, repeat.",
            2: "Same as Phase 1, with additional breathwork - Focus on 4 second inhales, 6 second exhales.",
            3: "Add mental imagery - Imagine pleasurable sex with partner while doing breathwork and Peak and Valley.",
            4: "Cliffhanger Training - Keep arousal between 8/10 and 9/10 for as long as possible.",
            5: "Stay at 8-9/10 by actively changing stimulation focus, grip intensity and speed.",
            6: "Use Fleshlight or similar toy with Cliffhanger training.",
            7: "Simulate thrusting with Fleshlight in stationary position.",
            8: "Final Reinforcement Phase - Continue maintenance to further boost results."
        };
        
        // Load saved data
        loadData();
        
        // Event listeners
        startBtn.addEventListener('click', toggleTimer);
        ponrBtn.addEventListener('click', recordFirstPONR);
        stopBtn.addEventListener('click', recordStop);
        orgasmBtn.addEventListener('click', recordOrgasm);
        endBtn.addEventListener('click', endSession);
        erectionSelect.addEventListener('change', updateErectionLevel);
        urgeSelect.addEventListener('change', updateUrgeLevel);
        
        // Handle page visibility changes for accurate timing
        document.addEventListener('visibilitychange', function() {
            if (isRunning && !document.hidden) {
                // Page became visible again - update timer immediately
                updateTimer();
            }
        });
        
        // Sound settings
        document.getElementById('soundEnabled').addEventListener('change', function() {
            localStorage.setItem('soundEnabled', this.checked);
        });
        
        document.getElementById('soundVolume').addEventListener('change', function() {
            localStorage.setItem('soundVolume', this.value);
            restEndAudio.volume = this.value;
        });
        
        document.getElementById('testSoundBtn').addEventListener('click', function() {
            restEndAudio.volume = document.getElementById('soundVolume').value;
            restEndAudio.play();
            setTimeout(() => {
                restEndAudio.currentTime = 0;
                restEndAudio.play();
            }, 300);
        });
        
        document.getElementById('restPeriodLength').addEventListener('change', function() {
            localStorage.setItem('restPeriodLength', this.value);
        });
        
        // Load sound settings
        const soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
        document.getElementById('soundEnabled').checked = soundEnabled;
        
        const soundVolume = localStorage.getItem('soundVolume') || 1;
        document.getElementById('soundVolume').value = soundVolume;
        restEndAudio.volume = soundVolume;
        
        const restPeriodLength = localStorage.getItem('restPeriodLength') || 30;
        document.getElementById('restPeriodLength').value = restPeriodLength;
        
        phaseButtons.forEach(button => {
            button.addEventListener('click', function() {
                phaseButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                currentPhase = this.getAttribute('data-phase');
                
                // Show day selector
                daySelector.style.display = 'block';
                
                // Reset day selection
                dayButtons.forEach(btn => btn.classList.remove('active'));
                currentDay = null;
                
                currentPhaseDisplay.textContent = `Phase ${currentPhase} - Select Day`;
                phaseDescription.textContent = phaseDescriptions[currentPhase] || "No description available";
                saveData();
            });
        });
        
        dayButtons.forEach(button => {
            button.addEventListener('click', function() {
                dayButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                currentDay = this.getAttribute('data-day');
                
                if (currentPhase && currentDay) {
                    currentPhaseDisplay.textContent = `Phase ${currentPhase}, Day ${currentDay}`;
                    
                    // Update completed days display based on current selection
                    const dayNumber = parseInt(currentDay);
                    completedDaysCount.textContent = Math.max(0, dayNumber - 1);
                    const percentage = Math.min(((dayNumber - 1) / 5) * 100, 100);
                    completedDaysFill.style.width = `${percentage}%`;
                }
                saveData();
            });
        });
        
        // Accurate timer functions using timestamps
        function toggleTimer() {
            if (!currentPhase || !currentDay) {
                alert("Please select both a phase and a day before starting the session.");
                return;
            }
            
            if (isRunning) {
                // Pause timer
                clearInterval(timerInterval);
                sessionPauseTime = Date.now();
                startBtn.textContent = 'Resume';
                isRunning = false;
            } else {
                if (!sessionStartTime) {
                    // Start new session
                    sessionStartTime = Date.now();
                    sessionPauseTime = null;
                    totalPausedTime = 0;
                    enableControls(true);
                    sessionNotes.disabled = false;
                } else if (sessionPauseTime) {
                    // Resume from pause
                    totalPausedTime += Date.now() - sessionPauseTime;
                    sessionPauseTime = null;
                }
                
                startBtn.textContent = 'Pause';
                startTimer();
                isRunning = true;
            }
        }
        
        function startTimer() {
            // Update immediately
            updateTimer();
            // Then update every 100ms for smooth display
            timerInterval = setInterval(updateTimer, 100);
        }
        
        function updateTimer() {
            if (isResting && Date.now() >= restEndTime) {
                isResting = false;
                statusIndicator.textContent = "Active - Continue Session";
                statusIndicator.classList.remove('rest-mode');
                statusIndicator.classList.add('active-mode');
                
                // Play sound alert when rest period ends (if enabled)
                const soundEnabled = document.getElementById('soundEnabled').checked;
                if (soundEnabled) {
                    restEndAudio.play();
                    setTimeout(() => {
                        restEndAudio.currentTime = 0;
                        restEndAudio.play();
                    }, 300);
                    setTimeout(() => {
                        restEndAudio.currentTime = 0;
                        restEndAudio.play();
                    }, 600);
                }
                
                // Visual alert
                statusIndicator.style.animation = 'flash 0.5s 3';
                setTimeout(() => {
                    statusIndicator.style.animation = '';
                }, 1500);
            }
            
            // Calculate elapsed time based on timestamps
            const currentTime = Date.now();
            const elapsedTime = currentTime - sessionStartTime - totalPausedTime;
            const remainingTime = Math.max(0, sessionDuration - elapsedTime);
            
            if (remainingTime <= 0) {
                clearInterval(timerInterval);
                timerDisplay.textContent = "00:00";
                alert("Session completed!");
                endSession();
                return;
            }
            
            // Convert to minutes and seconds
            const totalSeconds = Math.ceil(remainingTime / 1000);
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function recordFirstPONR() {
            if (!firstPONRTime) {
                const currentTime = Date.now();
                const sessionElapsedTime = currentTime - sessionStartTime - totalPausedTime;
                const elapsedSeconds = Math.floor(sessionElapsedTime / 1000);
                const minutes = Math.floor(elapsedSeconds / 60);
                const seconds = elapsedSeconds % 60;
                
                firstPONRTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                firstPONRDisplay.textContent = firstPONRTime;
                ponrBtn.disabled = true;
            }
        }
        
        function recordStop() {
            stopsCount++;
            stopsCountDisplay.textContent = stopsCount;
            
            // Get rest period length from settings
            const restLength = parseInt(document.getElementById('restPeriodLength').value) || 30;
            
            // Start rest period
            isResting = true;
            restEndTime = Date.now() + restLength * 1000;
            
            statusIndicator.textContent = `REST MODE - ${restLength} seconds`;
            statusIndicator.classList.remove('active-mode');
            statusIndicator.classList.add('rest-mode');
            
            // Create a countdown for the rest period
            const restCountdown = setInterval(() => {
                const remaining = Math.ceil((restEndTime - Date.now()) / 1000);
                if (remaining <= 0) {
                    clearInterval(restCountdown);
                } else {
                    statusIndicator.textContent = `REST MODE - ${remaining} seconds remaining`;
                }
            }, 1000);
        }
        
        function recordOrgasm() {
            hasRecordedOrgasm = true;
            orgasmBtn.disabled = true;
            alert("Orgasm recorded. Remember that for best results, try to avoid orgasm during training.");
        }
        
        function updateErectionLevel() {
            erectionLevelDisplay.textContent = erectionSelect.value;
        }
        
        function updateUrgeLevel() {
            urgeLevelDisplay.textContent = urgeSelect.value;
        }
        
        function enableControls(enabled) {
            ponrBtn.disabled = !enabled;
            stopBtn.disabled = !enabled;
            orgasmBtn.disabled = !enabled;
            endBtn.disabled = !enabled;
            erectionSelect.disabled = !enabled;
            urgeSelect.disabled = !enabled;
        }
        
        function endSession() {
            clearInterval(timerInterval);
            isRunning = false;
            
            // Calculate duration in minutes based on actual elapsed time
            const currentTime = Date.now();
            const sessionElapsedTime = currentTime - sessionStartTime - totalPausedTime;
            const duration = Math.round(sessionElapsedTime / (1000 * 60)); // Convert to minutes
            
            // Add session to log
            const sessionLog = document.getElementById('sessionLog').getElementsByTagName('tbody')[0];
            const newRow = sessionLog.insertRow();
            
            const today = new Date();
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayName = dayNames[today.getDay()];
            const month = today.getMonth() + 1;
            const day = today.getDate();
            const year = today.getFullYear().toString().substring(2);
            const dateStr = `${dayName}, ${month}/${day}/${year}`;
            
            newRow.insertCell().textContent = dateStr;
            newRow.insertCell().textContent = currentPhase ? `Phase ${currentPhase}` : '-';
            newRow.insertCell().textContent = currentDay ? `Day ${currentDay}` : '-';
            newRow.insertCell().textContent = `${duration} min`;
            newRow.insertCell().textContent = firstPONRTime || '-';
            newRow.insertCell().textContent = stopsCount;
            newRow.insertCell().textContent = erectionLevelDisplay.textContent;
            newRow.insertCell().textContent = hasRecordedOrgasm ? 'Yes' : 'No';
            newRow.insertCell().textContent = urgeLevelDisplay.textContent;
            newRow.insertCell().textContent = sessionNotes.value;
            
            // Update training progress if session was successful (no orgasm)
            if (!hasRecordedOrgasm && duration >= 15) { // Consider session successful if it lasted at least 15 minutes
                let completedDays = parseInt(completedDaysCount.textContent) || 0;
                completedDays++;
                completedDaysCount.textContent = completedDays;
                const percentage = Math.min((completedDays / 5) * 100, 100);
                completedDaysFill.style.width = `${percentage}%`;
                
                if (completedDays >= 5) {
                    alert("Congratulations! You've completed 5 days in this phase. Consider moving to the next phase if you're consistently controlling your arousal.");
                }
            }
            
            // Reset session
            resetSession();
            saveData();
        }
        
        function resetSession() {
            // Reset all timer variables
            sessionStartTime = null;
            sessionPauseTime = null;
            totalPausedTime = 0;
            firstPONRTime = null;
            stopsCount = 0;
            isResting = false;
            hasRecordedOrgasm = false;
            
            // Reset display
            timerDisplay.textContent = "20:00";
            firstPONRDisplay.textContent = "--:--";
            stopsCountDisplay.textContent = "0";
            
            statusIndicator.textContent = "Ready to Start";
            statusIndicator.classList.remove('rest-mode');
            statusIndicator.classList.add('active-mode');
            
            startBtn.textContent = "Start Session";
            
            erectionSelect.value = "-";
            urgeSelect.value = "-";
            erectionLevelDisplay.textContent = "-";
            urgeLevelDisplay.textContent = "-";
            sessionNotes.value = "";
            sessionNotes.disabled = true;
            
            enableControls(false);
        }
        
        function saveData() {
            const sessionData = Array.from(document.getElementById('sessionLog').getElementsByTagName('tbody')[0].rows).map(row => {
                return {
                    date: row.cells[0].textContent,
                    phase: row.cells[1].textContent,
                    day: row.cells[2].textContent,
                    duration: row.cells[3].textContent,
                    firstPONR: row.cells[4].textContent,
                    stops: row.cells[5].textContent,
                    erection: row.cells[6].textContent,
                    orgasm: row.cells[7].textContent,
                    urge: row.cells[8].textContent,
                    notes: row.cells[9].textContent
                };
            });
            
            const trainingData = {
                currentPhase: currentPhase,
                currentDay: currentDay,
                completedDays: parseInt(completedDaysCount.textContent) || 0,
                sessionLog: sessionData
            };
            
            safeSetItem('arousalControlTraining', JSON.stringify(trainingData));
        }
        
        function loadData() {
            const savedData = safeGetItem('arousalControlTraining');
            if (savedData) {
                const trainingData = JSON.parse(savedData);
                
                // Restore current phase and day
                if (trainingData.currentPhase) {
                    currentPhase = trainingData.currentPhase;
                    document.querySelector(`.phase-btn[data-phase="${currentPhase}"]`)?.classList.add('active');
                    daySelector.style.display = 'block';
                    phaseDescription.textContent = phaseDescriptions[currentPhase] || "No description available";
                    
                    if (trainingData.currentDay) {
                        currentDay = trainingData.currentDay;
                        document.querySelector(`.day-btn[data-day="${currentDay}"]`)?.classList.add('active');
                        currentPhaseDisplay.textContent = `Phase ${currentPhase}, Day ${currentDay}`;
                        
                        // Update completed days display based on saved selection
                        const dayNumber = parseInt(currentDay);
                        completedDaysCount.textContent = Math.max(0, dayNumber - 1);
                        const percentage = Math.min(((dayNumber - 1) / 5) * 100, 100);
                        completedDaysFill.style.width = `${percentage}%`;
                    } else {
                        currentPhaseDisplay.textContent = `Phase ${currentPhase} - Select Day`;
                    }
                }
                
                // Restore completed days (keep existing logic for old data)
                if (trainingData.completedDays !== undefined) {
                    // Only use saved completedDays if no current day is selected
                    if (!currentDay) {
                        completedDaysCount.textContent = trainingData.completedDays;
                        const percentage = Math.min((trainingData.completedDays / 5) * 100, 100);
                        completedDaysFill.style.width = `${percentage}%`;
                    }
                }
                
                // Restore session log
                if (trainingData.sessionLog && trainingData.sessionLog.length > 0) {
                    const sessionLog = document.getElementById('sessionLog').getElementsByTagName('tbody')[0];
                    
                    trainingData.sessionLog.forEach(session => {
                        const newRow = sessionLog.insertRow();
                        newRow.insertCell().textContent = session.date;
                        newRow.insertCell().textContent = session.phase || '-';
                        newRow.insertCell().textContent = session.day || '-';
                        newRow.insertCell().textContent = session.duration;
                        newRow.insertCell().textContent = session.firstPONR;
                        newRow.insertCell().textContent = session.stops;
                        newRow.insertCell().textContent = session.erection;
                        newRow.insertCell().textContent = session.orgasm;
                        newRow.insertCell().textContent = session.urge;
                        newRow.insertCell().textContent = session.notes;
                    });
                }
            }
        }
    </script>
</body>
</html>